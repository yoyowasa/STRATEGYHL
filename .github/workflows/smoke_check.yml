name: smoke_check

on:
  push:
  pull_request:

jobs:
  smoke:
    runs-on: windows-latest
    env:
      OUTPUTS_DIR: outputs_ci_f15
      REPORTS_DIR: reports_ci_f15_smoke
      MANIFEST_FAIL_LOG: logs\manifest_fail.log
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Clean CI directories
        shell: cmd
        run: |
          if exist "%OUTPUTS_DIR%" rmdir /s /q "%OUTPUTS_DIR%"
          if exist "%REPORTS_DIR%" rmdir /s /q "%REPORTS_DIR%"

      - name: Prepare smoke fixture
        shell: cmd
        run: |
          scripts\setup_smoke_fixture.bat

      - name: Run smoke_check
        shell: cmd
        run: |
          scripts\smoke_check.bat fixture_run_smoke_001
          echo ERRORLEVEL=%ERRORLEVEL%
          if not "%ERRORLEVEL%"=="0" exit /b %ERRORLEVEL%

      - name: Publish smoke summary
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            function safeList(dir) {
              try {
                return fs.readdirSync(dir, { withFileTypes: true });
              } catch {
                return [];
              }
            }

            function readLines(filePath) {
              try {
                return fs.readFileSync(filePath, 'utf8').split(/\r?\n/);
              } catch {
                return [];
              }
            }

            function interestingLines(lines) {
              const pats = ['[FAIL]', '[ERR]', 'EXIT_CODE=', 'RUN_ID=', 'runs_total'];
              return lines.filter((line) => pats.some((p) => line.includes(p)));
            }

            const logsRoot = path.join(process.cwd(), 'logs');
            const smokeDirs = safeList(logsRoot)
              .filter((d) => d.isDirectory() && d.name.startsWith('smoke_'))
              .map((d) => d.name)
              .sort();
            const latestSmokeDir = smokeDirs.length ? smokeDirs[smokeDirs.length - 1] : null;

            const summaryParts = [];
            summaryParts.push(`latest_smoke_dir=${latestSmokeDir ?? '(none)'}`);

            if (latestSmokeDir) {
              const dirPath = path.join(logsRoot, latestSmokeDir);
              const files = safeList(dirPath).filter((d) => d.isFile()).map((d) => d.name).sort();
              for (const file of files) {
                const fullPath = path.join(dirPath, file);
                const lines = interestingLines(readLines(fullPath)).slice(-20);
                summaryParts.push(`\n## ${path.posix.join(latestSmokeDir, file)}`);
                summaryParts.push(lines.length ? lines.join('\n') : '(no interesting lines)');
              }
            }

            const manifestFailPath = path.join(logsRoot, 'manifest_fail.log');
            if (fs.existsSync(manifestFailPath)) {
              const lines = interestingLines(readLines(manifestFailPath)).slice(-40);
              summaryParts.push(`\n## logs/manifest_fail.log`);
              summaryParts.push(lines.length ? lines.join('\n') : '(no interesting lines)');
            }

            const summary = summaryParts.join('\n').slice(0, 60000);

            const { owner, repo } = context.repo;
            const ref = context.sha;
            const checks = await github.rest.checks.listForRef({ owner, repo, ref, per_page: 100 });
            const checkRun = checks.data.check_runs.find((c) => c.name === process.env.GITHUB_JOB);

            if (!checkRun) {
              core.warning('check run not found for job: ' + process.env.GITHUB_JOB);
              core.summary.addRaw(summary).write();
              return;
            }

            await github.rest.checks.update({
              owner,
              repo,
              check_run_id: checkRun.id,
              output: {
                title: 'smoke summary',
                summary,
              },
            });

      - name: Run negative smoke (manifest missing)
        shell: cmd
        run: |
          scripts\smoke_manifest_fail.bat fixture_run_smoke_001
          echo ERRORLEVEL=%ERRORLEVEL%
          if not "%ERRORLEVEL%"=="0" exit /b %ERRORLEVEL%

      - name: Upload smoke logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: smoke-logs
          path: |
            logs/smoke_*
            logs/manifest_fail.log
