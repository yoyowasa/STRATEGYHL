name: smoke_check

on:
  push:
  pull_request:
  workflow_dispatch:
    inputs:
      run_id:
        description: "optional RUN_ID (blank = latest manifest run)"
        required: false
        default: ""

jobs:
  smoke:
    runs-on: windows-latest
    env:
      OUTPUTS_DIR: outputs_ci_f15
      REPORTS_DIR: reports_ci_f15_smoke
      MANIFEST_FAIL_LOG: logs\manifest_fail.log
      PYTHONIOENCODING: utf-8
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Clean CI directories
        shell: cmd
        run: |
          if exist "%OUTPUTS_DIR%" rmdir /s /q "%OUTPUTS_DIR%"
          if exist "%REPORTS_DIR%" rmdir /s /q "%REPORTS_DIR%"

      - name: Prepare smoke fixture
        shell: cmd
        run: |
          scripts\setup_smoke_fixture.bat

      - name: Run smoke_check
        shell: cmd
        env:
          RUN_ID: ${{ github.event.inputs.run_id }}
        run: |
          if "%RUN_ID%"=="" (
            scripts\smoke_check.bat
          ) else (
            scripts\smoke_check.bat %RUN_ID%
          )
          echo ERRORLEVEL=%ERRORLEVEL%
          if not "%ERRORLEVEL%"=="0" exit /b %ERRORLEVEL%

      - name: Publish smoke summary
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            function safeList(dir) {
              try {
                return fs.readdirSync(dir, { withFileTypes: true });
              } catch {
                return [];
              }
            }

            function readLines(filePath) {
              try {
                return fs.readFileSync(filePath, 'utf8').split(/\r?\n/);
              } catch {
                return [];
              }
            }

            function interestingLines(lines) {
              const pats = ['[FAIL]', '[ERR]', 'EXIT_CODE=', 'RUN_ID=', 'runs_total'];
              return lines.filter((line) => pats.some((p) => line.includes(p)));
            }

            const logsRoot = path.join(process.cwd(), 'logs');
            const smokeDirs = safeList(logsRoot)
              .filter((d) => d.isDirectory() && d.name.startsWith('smoke_'))
              .map((d) => d.name)
              .sort();
            const latestSmokeDir = smokeDirs.length ? smokeDirs[smokeDirs.length - 1] : null;

            const summaryParts = [];
            summaryParts.push(`latest_smoke_dir=${latestSmokeDir ?? '(none)'}`);

            if (latestSmokeDir) {
              const dirPath = path.join(logsRoot, latestSmokeDir);
              const files = safeList(dirPath).filter((d) => d.isFile()).map((d) => d.name).sort();
              const e2eFile = files.find((f) => f.startsWith('e2e_')) || files[0];
              if (e2eFile) {
                const fullPath = path.join(dirPath, e2eFile);
                const lines = readLines(fullPath);
                const tail = lines.slice(-80);
                summaryParts.push(`\n## tail ${path.posix.join(latestSmokeDir, e2eFile)}`);
                summaryParts.push(tail.length ? tail.join('\n') : '(empty log)');
              }
            }

            const manifestFailPath = path.join(logsRoot, 'manifest_fail.log');
            if (fs.existsSync(manifestFailPath)) {
              const lines = interestingLines(readLines(manifestFailPath)).slice(-40);
              summaryParts.push(`\n## logs/manifest_fail.log`);
              summaryParts.push(lines.length ? lines.join('\n') : '(no interesting lines)');
            }

            const summary = summaryParts.join('\n');
            const clipped = summary.slice(0, 4000);
            const hasFail = /\[FAIL\]|\[ERR\]|EXIT_CODE=1/.test(summary);
            core.summary.addCodeBlock(clipped, 'text').write();
            if (hasFail) {
              core.error(clipped);
            } else {
              core.notice(clipped);
            }

      - name: Run negative smoke (manifest missing)
        shell: cmd
        run: |
          scripts\smoke_manifest_fail.bat fixture_run_smoke_001
          echo ERRORLEVEL=%ERRORLEVEL%
          if not "%ERRORLEVEL%"=="0" exit /b %ERRORLEVEL%

      - name: Upload smoke logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: smoke-logs
          path: |
            logs/smoke_*
            logs/manifest_fail.log
